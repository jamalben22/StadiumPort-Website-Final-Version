name: Lighthouse Audits (Mobile & Desktop)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Setup Chrome
        id: setup-chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install Lighthouse CLI
        run: npm i -g lighthouse

      - name: Prepare output directories
        run: |
          mkdir -p lighthouse/mobile
          mkdir -p lighthouse/desktop

      - name: Run Lighthouse (Mobile HTML)
        env:
          CHROME_PATH: ${{ steps.setup-chrome.outputs.chrome-path }}
        run: |
          lighthouse https://stadiumport.com \
            --output=html \
            --output-path=./lighthouse/mobile/mobile.report.html \
            --save-assets \
            --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage --disable-gpu" \
            --quiet

      - name: Run Lighthouse (Mobile JSON)
        env:
          CHROME_PATH: ${{ steps.setup-chrome.outputs.chrome-path }}
        run: |
          lighthouse https://stadiumport.com \
            --output=json \
            --output-path=./lighthouse/mobile/mobile.report.json \
            --save-assets \
            --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage --disable-gpu" \
            --quiet

      - name: Run Lighthouse (Desktop HTML)
        env:
          CHROME_PATH: ${{ steps.setup-chrome.outputs.chrome-path }}
        run: |
          lighthouse https://stadiumport.com \
            --preset=desktop \
            --output=html \
            --output-path=./lighthouse/desktop/desktop.report.html \
            --save-assets \
            --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage --disable-gpu" \
            --quiet

      - name: Run Lighthouse (Desktop JSON)
        env:
          CHROME_PATH: ${{ steps.setup-chrome.outputs.chrome-path }}
        run: |
          lighthouse https://stadiumport.com \
            --preset=desktop \
            --output=json \
            --output-path=./lighthouse/desktop/desktop.report.json \
            --save-assets \
            --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage --disable-gpu" \
            --quiet

      - name: Upload Mobile Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-mobile
          path: |
            lighthouse/mobile/mobile.report.html
            lighthouse/mobile/mobile.report.json
            lighthouse/mobile/*report-assets/**

      - name: Upload Desktop Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-desktop
          path: |
            lighthouse/desktop/desktop.report.html
            lighthouse/desktop/desktop.report.json
            lighthouse/desktop/*report-assets/**